<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Auto Parts Finder</title>

<style>
:root{font-family:system-ui,Arial,sans-serif}
body{margin:0;background:#f6f7fb;color:#111}
.wrap{max-width:980px;margin:24px auto;padding:0 14px}
.card{background:#fff;border-radius:14px;padding:18px;box-shadow:0 10px 25px rgba(0,0,0,.08)}
h1{margin:0 0 6px;font-size:22px}
.sub{margin:0 0 14px;color:#555;font-size:14px}
.bar{margin:12px 0}
button{padding:10px 16px;border-radius:10px;border:none;background:#111;color:#fff;font-size:14px;cursor:pointer}
.grid{display:grid;gap:12px}
@media(min-width:860px){.grid{grid-template-columns:repeat(4,1fr)}}
label{display:block;font-size:13px;margin-bottom:6px}
select,input{width:100%;padding:10px;border-radius:10px;border:1px solid #ccc}
small{font-size:12px;color:#666}
.action{grid-column:1/-1}
.reset{background:#eee;color:#111;margin-top:10px}
</style>
</head>

<body>
<div class="wrap">
<div class="card">

<h1>Auto Parts Finder</h1>
<div class="sub">Select Year → Make → Model. Add engine size if you know it. Then press Research.</div>

<div class="bar">
<button onclick="window.top.location.href=WP_HOME_URL">⬅ Back to Website</button>
<span id="status">Loading…</span>
</div>

<div class="grid">
<div>
<label>Year</label>
<select id="year"></select>
</div>

<div>
<label>Make</label>
<select id="make" disabled></select>
<small>Auto-loaded</small>
</div>

<div>
<label>Model</label>
<select id="model" disabled></select>
<small>Auto-loaded</small>
</div>

<div>
<label>Engine size</label>
<input id="engine" placeholder="2.4L, 3.5L, Hybrid, EV">
</div>

<div>
<label>Part</label>
<select id="part">
<option value="">Select part</option>
<option>Brake Pads</option>
<option>Control Arm</option>
<option>Alternator</option>
<option>Battery</option>
<option>Radiator</option>
<option>Starter</option>
<option>Wheel Bearing</option>
</select>
</div>

<div class="action">
<label>Extra notes</label>
<input id="notes" placeholder="front, rear, left, right, OEM">
</div>

<div class="action">
<button onclick="research()">Research</button>
<button class="reset" onclick="resetAll()">Reset</button>
</div>
</div>

</div>
</div>

<script>
  // ====== GUARANTEED MAKES LOADER (never stuck) ======
const FALLBACK_MAKES = [
  "Acura","Audi","BMW","Buick","Cadillac","Chevrolet","Chrysler","Dodge","Ford","GMC",
  "Honda","Hyundai","Infiniti","Jeep","Kia","Lexus","Lincoln","Mazda","Mercedes-Benz",
  "Mini","Mitsubishi","Nissan","Ram","Subaru","Tesla","Toyota","Volkswagen","Volvo"
];

async function fetchJsonWithTimeout(url, ms = 6000) {
  const ctrl = new AbortController();
  const t = setTimeout(() => ctrl.abort(), ms);
  try {
    const res = await fetch(url, { signal: ctrl.signal });
    if (!res.ok) throw new Error("HTTP " + res.status);
    return await res.json();
  } finally {
    clearTimeout(t);
  }
}

function fillMakes(makes) {
  makeEl.innerHTML =
    "<option value=''>Select make</option>" +
    makes.map(m => `<option value="${m}">${m}</option>`).join("");
  makeEl.disabled = false;
}

async function loadMakesSafe() {
  statusEl.textContent = "Loading auto makes…";

  // If API is slow/down, we still finish quickly
  const types = ["Passenger Car", "Truck", "Multipurpose Passenger Vehicle (MPV)"];

  try {
    const results = await Promise.allSettled(
      types.map(t =>
        fetchJsonWithTimeout(
          `https://vpic.nhtsa.dot.gov/api/vehicles/GetMakesForVehicleType/${encodeURIComponent(t)}?format=json`,
          6000
        )
      )
    );

    const set = new Set();
    for (const r of results) {
      if (r.status === "fulfilled") {
        (r.value.Results || []).forEach(x => {
          if (x && x.MakeName) set.add(x.MakeName);
        });
      }
    }

    const makes = Array.from(set).sort((a,b)=>a.localeCompare(b));

    if (makes.length) {
      fillMakes(makes);
      statusEl.textContent = `Makes loaded (${makes.length})`;
    } else {
      // If nothing came back, use fallback
      fillMakes(FALLBACK_MAKES);
      statusEl.textContent = "Using backup makes list.";
    }
  } catch (e) {
    // Any failure -> fallback (never stuck)
    fillMakes(FALLBACK_MAKES);
    statusEl.textContent = "Using backup makes list.";
  }
}

// Run on page load
window.addEventListener("DOMContentLoaded", () => {
  // Set a visible loading state immediately
  makeEl.disabled = true;
  makeEl.innerHTML = "<option>Loading…</option>";
  loadMakesSafe();
}); 
/* EVENTS */
yearEl.onchange=async()=>{
 makeEl.disabled=true;modelEl.disabled=true;
 makeEl.innerHTML="<option>Loading…</option>";
 const m=await loadMakes();
 makeEl.innerHTML="<option value=''>Select make</option>"+m.map(x=>`<option>${x}</option>`).join("");
 makeEl.disabled=false;
 statusEl.textContent="Makes loaded";
};

makeEl.onchange=async()=>{
 modelEl.disabled=true;
 modelEl.innerHTML="<option>Loading…</option>";
 const models=await loadModels(yearEl.value,makeEl.value);
 modelEl.innerHTML="<option value=''>Select model</option>"+models.map(x=>`<option>${x}</option>`).join("");
 modelEl.disabled=false;
};

/* ACTIONS */
function research(){
 if(!yearEl.value||!makeEl.value||!modelEl.value){alert("Please select Year, Make, and Model");return;}
 const q=[document.getElementById("part").value,yearEl.value,makeEl.value,modelEl.value,document.getElementById("engine").value,document.getElementById("notes").value].filter(Boolean).join(" ");
 window.top.location.href=WP_SEARCH_URL+"?s="+encodeURIComponent(q)+"&post_type=product";
}
</script>
</body>
</html>
